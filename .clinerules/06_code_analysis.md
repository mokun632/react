# コード分析に関するルール

このドキュメントは、React コードベースのリーディングやリファクタリング支援を効果的に行うためのガイドラインを定めます。

## 1. コードリーディング戦略

*   **トップダウンアプローチ**
    *   メインエントリーポイントから始めてコールグラフを下る
    *   React.js → ReactDOM.js → ReactReconciler → ReactFiberWorkLoop などの流れ
    *   主要な API やエクスポートから内部実装へと追跡

*   **ボトムアップアプローチ**
    *   特定の機能や問題から始めて関連コードを探索
    *   エラーメッセージや特定の挙動に関連するコード箇所の特定
    *   依存関係の逆方向追跡

*   **概念重視アプローチ**
    *   Fiber, Hooks, Concurrent Mode などの特定概念に焦点
    *   概念が実装されている複数のファイルを横断的に調査
    *   特定の概念に関連するテストコードや例示コードの参照

## 2. 静的解析技術

*   **シンボル参照追跡**
    *   関数や変数の定義と参照箇所の特定
    *   コード内の特定シンボルの全使用箇所を `search_files` で検索
    *   型情報（Flow/TypeScript）を活用した関連性の把握

*   **コールグラフ分析**
    *   関数呼び出しの連鎖を視覚化
    *   特定機能の実行フロー追跡
    *   循環依存や複雑な依存関係の検出

*   **データフロー分析**
    *   状態更新の流れを追跡
    *   プロパティや引数がどのように各レイヤーを通過するか調査
    *   副作用の伝播パターンの特定

## 3. パターン認識と分類

*   **コードパターンの識別**
    *   共通設計パターン（Factory、Observer、Singleton など）の特定
    *   React 固有パターン（HOC, Render Props, Hooks など）の識別
    *   最適化パターン（メモ化、遅延評価など）の検出

*   **アンチパターンの検出**
    *   無限ループのリスクがあるコード
    *   メモリリークを引き起こす可能性のあるパターン
    *   パフォーマンス上の問題を引き起こす構造

*   **コード品質指標**
    *   複雑度の高い関数や過度に長いファイルの特定
    *   重複コードや類似パターンの検出
    *   テストカバレッジ不足の領域の特定

## 4. リファクタリング支援

*   **コード改善提案**
    *   パフォーマンス最適化のための変更提案
    *   可読性向上のためのリファクタリング案
    *   モジュール分割や責務分離のためのリアーキテクチャ提案

*   **リファクタリングの安全性評価**
    *   変更の影響範囲（影響を受ける他のコード）の特定
    *   副作用リスクの分析
    *   互換性維持のための考慮事項

*   **段階的なリファクタリング計画**
    *   大規模変更の小さなステップへの分割
    *   各ステップのテスト戦略
    *   ロールバック計画と中間チェックポイント

## 5. ドキュメンテーション強化

*   **コード注釈**
    *   複雑なアルゴリズムや設計決定の説明
    *   エッジケースや特殊な処理に関する注記
    *   将来の拡張ポイントや改善余地の特定

*   **可視化補助**
    *   コンポーネント階層やデータフローの図示（Mermaid など）
    *   アルゴリズムやプロセスのフローチャート
    *   モジュール間の依存関係の視覚化

*   **コードマップ生成**
    *   主要ファイルとその関係性の概要マップ
    *   特定機能の実装箇所を示すナビゲーション
    *   複雑なサブシステムの構造説明

## 6. Cline への指示

*   コード分析の依頼を受けた場合:
    *   分析の目的と範囲を確認（全体把握、特定機能理解、問題診断など）
    *   適切な分析アプローチ（トップダウン、ボトムアップ、概念重視）の選択
    *   分析結果の提示形式（テキスト解説、図表、コード注釈など）の調整

*   リファクタリング支援を提供する場合:
    *   現状のコードの問題点や改善余地を明確に説明
    *   提案する変更の根拠と期待される効果を示す
    *   リスクと副作用を透明に伝え、適切な対応策を提案

*   コードマップやドキュメント生成を行う場合:
    *   情報の階層化と要約（詳細は折りたたみ可能に）
    *   視覚的要素と説明テキストの適切なバランス
    *   ユーザーの技術レベルに合わせた説明の調整

## 7. 注意点

*   コードベースが大規模なため、全体を一度に理解しようとせず、焦点を絞った分析を行う
*   React の進化により、古いコードパターンと新しいパターンが混在している可能性がある
*   実験的機能や非推奨機能に関するコードは、メインコードとは異なる設計原則を持つ場合がある
*   パフォーマンス最適化のためのコードは、通常よりも複雑で読みにくい場合が多い
